var guardian=window.guardian||{};guardian.facebook=guardian.facebook||{};if(typeof console=="undefined"){var console={};console.log=console.error=console.info=console.debug=console.warn=console.trace=console.dir=console.dirxml=console.group=console.groupEnd=console.time=console.timeEnd=console.assert=console.profile=function(){}}(function(){function t(){e=this,this.onConnected=new r,this.onFBScriptLoaded=new r,this.onUserDataLoaded=new r,this.onNotAuthorized=new r,this.onNotLoggedIn=new r,this.cancelledLogin=new r}function r(){this.callbacks=[]}if(guardian.facebook.Authorizer)return;var e=null;t.DEFAULT_PERMISSIONS={scope:"email,publish_actions,publish_stream"},t.prototype.onConnected=null,t.prototype.onFBScriptLoaded=null,t.prototype.onUserDataLoaded=null,t.prototype.onNotAuthorized=null,t.prototype.onNotLoggedIn=null,t.prototype.cancelledLogin=null,t.accessToken=null,t.userId=null,t.userData=null,t.prototype.login=function(e,n){if(n||!this.accessToken&&!this.loginPending)this.cancelledLogin.reset(),this.onConnected.reset(),this.loginPending=!0,this._loadFacebookAPI().then(function(n){n.login(this._handleGotLoginStatus.bind(this,!0),e||t.DEFAULT_PERMISSIONS)}.bind(this));return this.onConnected},t.prototype.getLoginStatus=function(e){return this.loginStatusPending||(this.loginStatusPending=!0,this._loadFacebookAPI().then(function(n){n.getLoginStatus(this._handleGotLoginStatus.bind(this,!1),e||t.DEFAULT_PERMISSIONS)}.bind(this))),this.onConnected},t.prototype.getAppId=function(){var e=window.identity&&identity.facebook&&identity.facebook.appId,t=document.querySelector&&document.querySelector("meta[property='fb:app_id']");return e||t&&t.content};var n="facebook-jssdk";t.prototype._handleGotLoginStatus=function(e,t){this.loginStatusPending=!1,this.loginPending=!1;switch(t.status){case"connected":this.accessToken=t.authResponse.accessToken,this.userId=t.authResponse.userID,this._getUserData(),this.onConnected.resolve(FB,t.authResponse);break;case"not_authorized":this._getUserData(),this.onNotAuthorized.resolve(this);break;default:e&&this.cancelledLogin.resolve(),this.onNotLoggedIn.resolve()}},t.prototype._getUserData=function(){FB.api("/me",this._handleGotUserData.bind(this))},t.prototype._handleGotUserData=function(e){e&&!e.error&&(this.userData=e,this.onUserDataLoaded.resolve(e))},t.prototype._loadFacebookAPI=function(){return window.FB?this.onFBScriptLoaded.resolve(window.FB):!document.getElementById(n)&&!this._requiredAlready&&(this._requiredAlready=!0,this._loadFacebookScript()),this.onFBScriptLoaded},t.prototype._loadFacebookScript=function(){require(["//connect.facebook.net/en_US/all.js"],this._handleScriptLoaded.bind(this))},t.prototype._handleScriptLoaded=function(){FB.init({appId:this.getAppId(),channelUrl:"//"+document.location.host+":"+document.location.port+"/channel.html",status:!0,cookie:!0,xfbml:!0}),this.onFBScriptLoaded.resolve(FB)},t.prototype.destroy=function(){e=null},r.prototype.resolve=function(){this.args=Array.prototype.slice.apply(arguments);var e,t=this.callbacks.length;for(e=0;e<t;e++)this.callbacks[e].apply(null,this.args);this.callbacks=[]},r.prototype.then=function(e){this.args!==undefined?e.apply(null,this.args):this.callbacks.push(e)},r.prototype.reset=function(){this.args=undefined},guardian.facebook.Authorizer={getInstance:function(){return e||new t}}})();