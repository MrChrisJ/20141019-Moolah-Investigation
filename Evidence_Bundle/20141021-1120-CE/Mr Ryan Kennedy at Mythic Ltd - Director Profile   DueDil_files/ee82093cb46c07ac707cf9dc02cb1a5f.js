/* app-quicksearch.js */
define("text!quick-search/full-screen-template.html",[],function(){return'<ul class="js-toggle-search-type search-toggle">\n  <li class="js-search-toggle-option selected" data-type="companies">Companies</li>\n  <li class="slash">/</li>\n  <li class="js-search-toggle-option" data-type="directors">Directors</li>\n</ul>\n<div class="full-screen-inner">\n  <div class="search-bar">\n    <div class="spinning-search-loader"></div>\n    <form>\n      <input class="js-search-field large-search-field" type="text" name="search" autocapitalize="off" autocorrect="off" autocomplete="off" autofocus/>\n    </form>\n    <span class="js-placeholder faux-placeholder">Search companies</span>\n    <a class="js-advanced-search-link advanced-search-link" data-base-url="/search/" href="/search/companies">\n      More search options\n    </a>\n  </div>\n  <div class="js-search-results">\n  </div>\n</div>\n<div class="icon-font icon-cross-rounded js-close-search close-cross-button" role="button" onclick=""></div>\n'}),define("text!quick-search/no-results-template.html",[],function(){return'<div class="search-results-message">\n  <h1 class="icon-font icon-cross-circle"></h1>\n  <h2>No results found for <strong><%- query %></strong></h2>\n  <a href="/search/<%- searchType %>">Try a refined advanced search for more options</a>\n</div>\n'}),define("text!quick-search/more-results-template.html",[],function(){return'<div class="search-results-message">\n  <h1 class="icon-font icon-sidebar-arrow"></h1>\n  <h2>Another <strong><%= moreResults %></strong> result<% if (plural){%>s<%}%> found for <strong><%- query %></strong></h2>\n  <a href="/search/<%- searchType %>?name=<%= encodeURIComponent(query) %>">Refine your results in advanced search</a>\n</div>\n'}),define("text!quick-search/error-message-template.html",[],function(){return'<div class="search-results-message">\n  <h1 class="icon-font icon-warning"></h1>\n  <h2><% if (errorMessage) { print(errorMessage) } else { %>Ooops! Something went wrong with your request! <% } %></h2>\n  <a href="#" class="js-retry-search">Retry search</a>\n</div>\n'}),define("text!quick-search/company-template.html",[],function(){return'<div class="search-result-wrapper">\n  <div class="search-result">\n    <h2>\n      <a href="<%= url %>" class="js-fss-company-name-result" data-pjax="#main">\n        <%= company_name %>\n      </a>\n    </h2>\n    <h5 class="industry"><%= description %></h5>\n    <% if (website){ %>\n      <a class="company-website" href="<%= website %>" target="_blank" rel="nofollow"><%= website %></a>\n    <% } %>\n    <% if (directors){ %>\n      <h6><a href="<%= url %>/people" class="js-fss-people-link" data-pjax="#main">Directors <% if (directorships_count > directors.length){ %>(<%= directors.length %>/<%= directorships_count %>)<% } %></a></h6>\n      <ul class="directors">\n        <% _.each(directors, function(director){ %>\n          <li class="director-link">\n            <a href="<%= director.url %>" class="js-fss-director-link" data-pjax="#main"><%= director.name.toLowerCase() %></a>\n          </li>\n        <% }); %>\n      </ul>\n    <% } %>\n    <p class="about-text"><%= about %></p>\n  </div>\n</div>\n'}),define("quick-search/companyView",["jquery","underscore","common/EventBinding","text!quick-search/company-template.html"],function(e,t,n,r){var i=function(){this.initialize.apply(this,arguments)};return t.extend(i.prototype,{initialize:function(n,i){function o(e){return e?e.replace(new RegExp("("+i+")","gi"),"<strong>$1</strong>"):""}var s=n;s.company_name=o(n.company_name),s.about=o(n.about),this.html=e.trim(t.template(r,s))}}),i}),define("text!quick-search/director-template.html",[],function(){return'<div class="search-result-wrapper">\n  <div class="search-result">\n    <h2>\n      <a href="<%= url %>" class="js-fss-director-name-result" data-pjax="#main">\n        <%= director_name %>\n      </a>\n    </h2>\n    <% if (directorships) { %>\n      <h6><a href="<%= url %>/directorships"  class="js-fss-directorships-link" data-pjax="#main">Directorships <% if (directorships_count > directorships.length){ %>(<%= directorships.length %>/<%= directorships_count %>)<% } %></a></h6>\n      <ul class="companies">\n        <% _.each(directorships, function(company){ %>\n          <li class="company-link">\n            <a href="<%= company.url %>" class="js-fss-company-link" data-pjax="#main"><%= company.name.toLowerCase() %></a>\n          </li>\n        <% }); %>\n      </ul>\n    <% } %>\n    <p class="about-text"><%= about %></p>\n  </div>\n</div>\n'}),define("quick-search/directorView",["jquery","underscore","common/EventBinding","text!quick-search/director-template.html"],function(e,t,n,r){var i=function(){this.initialize.apply(this,arguments)};return t.extend(i.prototype,{initialize:function(n,i){function o(e){return e?e.replace(new RegExp("("+i+")","gi"),"<strong>$1</strong>"):""}var s=n;s.director_name=o(n.director_name),s.about=o(n.about),this.html=e.trim(t.template(r,s))}}),i}),define("quick-search/fullScreenView",["jquery","underscore","common/EventBinding","text!quick-search/full-screen-template.html","text!quick-search/no-results-template.html","text!quick-search/more-results-template.html","text!quick-search/error-message-template.html","quick-search/companyView","quick-search/directorView","common/Emitter","common/Duedil.helpers","Modernizr","third-party/domReady!"],function(e,t,n,r,i,s,o,u,a,f,l){var c="full-screen-search",h="webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",p=3e3,d=3,v=function(){this.initialize.apply(this,arguments)};return t.extend(v.prototype,f.prototype,{className:"js-full-screen full-screen-overlay",initialize:function(){this.$element=e("<div/>",{"class":this.className,onclick:""}),this.$element.html(r),this.bindings=[],this.searchType="companies",this.$placeholder=this.$element.find(".js-placeholder"),this.$input=this.$element.find(".js-search-field"),this.timeout=p,this.timeoutRetries=0,this.debouncedRequest=t.debounce(v.prototype.request,250),this.bindings.push(new n({el:e(window),eventType:"keyup",handler:t.bind(function(e){e.which===27&&this.exit()},this)}),new n({el:this.$element,selector:".js-close-search",eventType:"click",handler:t.bind(function(e){this.exit()},this)}),new n({el:this.$element,selector:".js-search-field",eventType:"keyup",handler:t.bind(function(t){var n=e(t.currentTarget).val();this.togglePlaceholder(!(n.length>0)),this.updateTopBarField(n),n.length<1&&(this.emptyResults(),this.moveSearchDown()),this.updateSearchLink(),this.query(n,t.which===13)},this)}),new n({el:this.$element,selector:"[data-pjax]",eventType:"click",handler:t.bind(function(e){e.ctrlKey||e.metaKey||e.shiftKey||this.exit()},this)}),new n({el:this.$element,selector:".js-search-toggle-option:not(.selected)",eventType:"click",handler:t.bind(function(t){var n=e(t.currentTarget);n.siblings().removeClass("selected"),n.addClass("selected"),this.toggleOption(t.currentTarget.getAttribute("data-type")),this.focus();var r=this.searchTerm();r.length>0&&this.query(r)},this)}),new n({el:this.$element,selector:"form",eventType:"submit",handler:function(e){e.preventDefault()}}),new n({el:this.$element,eventType:"click",handler:t.bind(function(e){e.srcElement===this.$element.get(0)&&this.exit()},this)}),new n({el:this.$element,eventType:"click",selector:".js-retry-search",handler:t.bind(function(e){e.preventDefault(),this.timeout=p,this.timeoutRetries=0,this.moveSearchDown(),this.emptyResults(),this.retryRequest()},this)}),new n({el:this.$element,eventType:"click",selector:".js-placeholder",handler:t.bind(function(e){this.focus()},this)})),this.$element.hide(),e("body").append(this.$element)},toggleOption:function(e){this.searchType=e,this.$placeholder.text("Search "+this.searchType),this.lastSearch="",this.updateSearchLink()},togglePlaceholder:function(e){e?this.$placeholder.removeClass("hidden"):this.$placeholder.addClass("hidden")},updateSearchLink:function(){var t=this.$element.find(".js-advanced-search-link"),n=t.attr("data-base-url")+this.searchType,r=this.searchTerm(),i=e.param({name:r}),s=r.length>0?n+"?"+i:n;t.attr({href:s})},updateTopBarField:function(t){var n=e(".js-search-query"),r="js-user-content",i=40,s=t.length>i?t.substring(0,i-3)+"...":t;s.length>0?n.text(s).addClass(r):n.text(n.attr("data-original-text")).removeClass(r)},searchTerm:function(){return this.$input.val()},clear:function(){this.$input.val("")},emptyResults:function(){this.$element.find(".js-search-results").empty()},moveSearchUp:function(){this.$element.find(".full-screen-inner").addClass("has-content")},moveSearchDown:function(){this.$element.find(".full-screen-inner").removeClass("has-content")},templateCompanies:function(e,n){var r=e.results;if(r.length>0){var i=[];t.each(r,function(e){i.push((new u(e,n,this.searchType)).html)}),this.$element.find(".js-search-results").html(i.join("")),this.templateMoreResults(e,n)}else this.templateNoResults()},templateDirectors:function(e,n){var r=e.results;if(r.length>0){var i=[];t.each(r,function(e){i.push((new a(e,n)).html)}),this.$element.find(".js-search-results").html(i.join("")),this.templateMoreResults(e,n)}else this.templateNoResults()},templateMoreResults:function(e,n){e.total>e.results.length&&this.$element.find(".js-search-results").append(t.template(s,{moreResults:l.separateThousands(e.total-e.results.length),plural:e.total-e.results.length>1,query:n,searchType:this.searchType}))},templateNoResults:function(){this.$element.find(".js-search-results").html(t.template(i,{query:this.lastSearch,searchType:this.searchType}))},templateResultsError:function(e){this.emptyResults(),this.$element.find(".js-search-results").html(t.template(o,{errorMessage:e}))},query:function(e,t){var n=e!==this.lastSearch||t;Modernizr.touch&&t&&this.blur(),n&&(this.lastSearch=e,this.xhr&&this.xhr.abort(),e.length>=2||t&&e.length>0?(this.loading(),this.debouncedRequest(e)):this.loadingEnd())},request:function(t){this.trigger("request",t),this.xhr=e.ajax({url:"/minisearch/"+this.searchType+"/"+encodeURIComponent(t),context:this,dataType:"json",timeout:this.timeout,success:function(e){this.requestComplete(e,t),this.timeoutRetries=0},error:function(n,r){if(r==="timeout")this.requestTimeout(t);else if(r!=="abort"){var i;try{var s=e.parseJSON(n.responseText);i=response.error&&response.error.message?response.error.message:i}catch(o){}this.requestError(i,t)}}})},requestComplete:function(e,t){var n=this.searchType==="directors";this.trigger("results",t),this.timeout=p,this.loadingEnd(),this.moveSearchUp(),this.emptyResults(),n?this.templateDirectors(e,t):this.templateCompanies(e,t)},requestTimeout:function(e){this.trigger("timeout",e,this.timeoutRetries),this.timeoutRetries>=d-1?this.requestError(null,e):(this.timeoutRetries++,this.timeout*=2,this.retryRequest())},requestError:function(e,t){this.trigger("error",t),this.loadingEnd(),this.emptyResults(),this.moveSearchUp(),this.templateResultsError(e)},retryRequest:function(){this.loading(),this.request(this.searchTerm())},show:function(){if(!this.visible){this.trigger("show"),this.visible=!0,e("body").addClass(c);var n=this.$input.val(),r=this.$element,i=t.bind(function(t){t&&t.currentTarget&&e(t.currentTarget).removeClass("fade-in-scale"),this.focus()},this);Modernizr.cssanimations?this.$element.show().addClass("fade-in-scale").one(h,i):this.$element.fadeIn(i),n.length>0?(this.moveSearchUp(),this.highlightText()):this.moveSearchDown(),this.focus()}},focus:function(){t.defer(function(e){e.$input.focus()},this)},blur:function(){this.$input.blur()},loading:function(){this.$element.find(".search-bar").addClass("is-loading")},loadingEnd:function(){this.$element.find(".search-bar").removeClass("is-loading")},reflow:function(){var e=this.$element.get(0);e.offsetWidth=e.offsetWidth},highlightText:function(){this.$input.select()},exit:function(){this.visible&&(this.trigger("hide"),e("body").removeClass(c),this.visible=!1,Modernizr.cssanimations?(this.reflow(),this.$element.addClass("fade-out-scale").one(h,t.bind(function(){this.$element.removeClass("fade-out-scale").hide(),this.reflow(),this.visible=!1,document.body.style.display="none",document.body.offsetHeight,document.body.style.display="block"},this))):this.$element.fadeOut(t.bind(function(){this.$element.removeClass("fade-out-scale").hide()},this)))}}),new v}),define("app/app-quicksearch",["jquery","underscore","quick-search/fullScreenView","common","third-party/domReady!"],function(e,t,n,r){return{bind:function(){e(document).on("click",".js-quick-search",function(){n.show()}),e(document).on("keyup",function(t){t.which===191&&e("input:focus, select:focus, textarea:focus").length===0&&n.show()}),n.on("show",function(){r.analytics.track("full-screen-search-shown")}),n.on("hide",function(){r.analytics.track("full-screen-search-hidden")}),n.on("request",function(e){r.analytics.track("full-screen-search-request",{query:e,numberOfRetries:n.timeoutRetries,searchType:n.searchType})}),n.on("results",function(e){r.analytics.track("full-screen-search-results-shown",{query:e,numberOfRetries:n.timeoutRetries,searchType:n.searchType})}),n.on("error",function(e){r.analytics.track("full-screen-search-error",{query:e,numberOfRetries:n.timeoutRetries,searchType:n.searchType})})}}});